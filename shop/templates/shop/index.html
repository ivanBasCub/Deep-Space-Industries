{% extends 'base.html' %}
{% load static %}
{% load filters %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/shop.css' %}">
<link rel="stylesheet" href="{% static 'css/buyback.css' %}">
<title>Shop - Deep Core Industry</title>
{% endblock %}

{% block title %}
Shop
{% endblock %}

{% block navbar_menu %}
<ul class="nav navbar-nav me-auto">
    <li class="nav-item">
        <a href="/shop/orders/history/" class="nav-link py-0">
            <span class="btn btn-secondary">Orders History</span>
        </a>
    </li>
</ul>
<ul class="nav navbar-nav">
    {% if request.user|has_group:"Admin" %}
    <li class="nav-item py-0 ms-2">
        <a href="/shop/orders/history/admin/" class="nav-link py-0">
            <span class="btn btn-primary">View all Orders</span>
        </a>
    </li>
    <li class="nav-item py-0 ms-2">
        <a href="/shop/orders/" class="nav-link py-0">
            <span class="btn btn-primary">Pending Orders</span>
        </a>
    </li>
    <li class="nav-item py-0 ms-2">
        <a href="/shop/items/" class="nav-link py-0">
            <span class="btn btn-primary">Modify Products</span>
        </a>
    </li>
    {% endif %}
    <li class="nav-item py-0">
        <button class="btn btn-warning" data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas">
            <i class="bi bi-basket2-fill"></i>
        </button>
    </li>
</ul>
{% endblock %}

{% block content %}
<div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">My Cart</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>

    <div class="offcanvas-body d-flex flex-column">

        {% if cart_items %}
            <div class="flex-grow-1 overflow-auto">

                {% for ci in cart_items %}
                    <div class="position-relative border-bottom pb-2 mb-2">
                        <a href="/shop/cart/{{ ci.item.item_id }}/del/"
                           class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2">
                            <i class="bi bi-trash"></i>
                        </a>

                        <img src="https://image.eveonline.com/Type/{{ ci.item.item_id }}_32.png" class="rounded">
                        <strong>{{ ci.item.item_name }}</strong><br>
                        Quantity: {{ ci.quantity }}<br>
                        Price (Unit): {{ ci.item.price|format_number }} ISK<br>
                        Subtotal: {{ ci.subtotal|format_number }} ISK
                    </div>
                {% endfor %}

            </div>

            <div class="mt-3 border-top pt-3">
                <div class="d-flex justify-content-between mb-2">
                    <strong>Total:</strong>
                    <strong>{{ total|format_number }} ISK</strong>
                </div>

                <a href="/shop/order/confirm/" class="btn btn-success w-100">
                    Checkout 
                </a>
            </div>

        {% else %}
            <p class="text-muted text-center">The cart is empty</p>
        {% endif %}
    </div>
</div>

<div class="my-3">
    <div class="card">
        <div class="card-header">
            <h5 class="text-center m-0">Available Products</h5>
        </div>
        <div class="card-body p-1">
            <div class="row">
                <div class="col-12 col-lg-4">
                    <input type="text" id="filterInput" class="form-control" placeholder="Search Item ...">
                </div>

                {% if messages %}
                    {% for message in messages %}
                    <div class="mx-auto col-10 col-lg-6 text-center alert alert-{{message.tags}} m-0 p-1">
                        {{ message }}
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>

    <div class="container-fluid m-0 p-0">
        <div class="d-flex flex-wrap justify-content-start">
            {% for item in list_items %}
            <div class="card m-1">
                <div class="card-header text-center">
                    {{item.item_name}}
                </div>
                <div class="card-body">
                    <div class="d-flex flex-warp justify-content-start">
                        <img src="https://image.eveonline.com/Type/{{item.item_id}}_64.png" class="rounded">
                        <div class="container">
                            <h6 class="p-0 m-0">Quantity: {{item.quantity}}</h6>

                        </div>
                    </div>
                    <h6 class="m-0">Price: {{item.price|format_number}} ISK</h6>
                </div>
                <div class="card-footer p-1">
                    <form method="post" class="container p-0">
                        {% csrf_token %}
                        <input type="hidden" name="product_id" value="{{item.item_id}}">
                        <div class="row">
                            <div class="col-12 col-sm-8">
                                <input class="form-control" type="number" name="quantity" min="1"
                                    max="{{item.quantity}}"
                                    placeholder="{% if item.quantity != 0 %}1 - {{item.quantity}}{% endif %}" required>
                            </div>
                            <div class="col-12 col-sm-4">
                                <button
                                    class="btn btn-success w-100 {% if not item.status or item.quantity == 0 %} disabled {% endif %}"
                                    type="submit">
                                    <i class="bi bi-cart"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const input = document.getElementById("filterInput");
        const cards = document.querySelectorAll(".container-fluid .card");

        input.addEventListener("input", function () {
            const filter = input.value.toLowerCase();

            cards.forEach(card => {
                const name = card.querySelector(".card-header").textContent.toLowerCase();

                if (name.includes(filter)) {
                    card.style.display = "block";
                } else {
                    card.style.display = "none";
                }
            });
        });
    });
</script>

{% endblock %}