{% extends 'base.html' %}
{% load static %}
{% load filters %}

{% block style %}
    <link rel="stylesheet" href="{% static 'css/buyback.css' %}">
    <link rel="stylesheet" href="{% static 'css/calculate.css' %}">
    <title>Buyback Program - Deep Space Industry</title>
{% endblock %}


{% block title %}
    Buyback Program
{% endblock %}

{% block navbar_menu %}
{% if request.user|has_group:"Admin" %}
<ul class="nav navbar-nav sub-nav">
    <li class="nav-item sub-item">
        <a href="/manager/login/" class="btn btn-primary">Setup Manager</a>
    </li>
    <li class="nav-item sub-item">
        <a href="/locations/" class="btn btn-primary">Locations</a>
    </li>
</ul>
{% endif %}
{% endblock %}

{% block content %}
<div class="my-3">
    {% if messages %}
    <div class="card">
        <div class="card-header">
            Messages Info
        </div>
        
        {% for message in messages %}
            <div class="card-body text-center alert alert-{{message.tags}}">
                {{ message }}
            </div>
        {% endfor %}
        
    </div>
    {% endif %}
    {% if contract %}
    <div class="card" style="margin-top: 10px;">
        <div class="card-header">
            Accepted location(s)
        </div>
        <div class="card-body">
            <table class="table table-striped table-hover no-footer w-100">
                <tbody>
                    <tr>
                        <td>{{program.location.station_name}}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="card" style="margin-top: 10px;">
        <div class="card-header">
            Contract Settings
        </div>
        <div class="card-body">
            <table class="table no-footer w-100">
                <tbody>
                    <tr>
                        <th>Contract type</th>
                        <td>Item Exchange</td>
                        <td></td>
                    </tr>
                    <tr>
                        <th>Availability</th>
                        <td data-type="copy_value">{{program.manager.character_name}}</td>
                        <td>
                            <button data-type="copy" class="btn btn-info btn-sm">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <th>I will receive</th>
                        <td data-type="copy_value">{{contract.net_price|format_number}}</td>
                        <td>
                            <button data-type="copy" class="btn btn-info btn-sm">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <th>Expiration</th>
                        <td>2 weeks</td>
                        <td></td>
                    </tr>
                    <tr>
                        <th>Description</th>
                        <td data-type="copy_value">{{contract.contract_id}}</td>
                        <td>
                            <button data-type="copy" class="btn btn-info btn-sm">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="card" style="margin-top: 10px;">
        <div class="card-header">
            Invonce
        </div>
        <div class="card-body">
            <table class="table no-footer w-100">
                <tbody>
                    <tr>
                        <th>Prices based on</th>
                        <td>
                            {% if program.jita_buy %}
                                Jita Buy price
                            {% else %}
                                Jita Sell price
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Price before expenses</th>
                        <td>{{contract.raw_price|format_number}} ISK</td>
                    </tr>
                    <tr>
                        <th>Program taxes</th>
                        <td>{{contract.general_tax|format_number}} ISK</td>
                    </tr>
                    <tr>
                        <th>Total volume</th>
                        <td>{{contract.total_volume|format_number}} m&sup3;</td>
                    </tr>
                    {% if program.freighter %}
                    <tr>
                        <th>Hauling Cost</th>
                        <td>{{contract.freigther_tax|format_number}} ISK ( {{program.freighter_tax}} ISK / m&sup3; )</td>
                    </tr>
                    {% endif %}
                    {% if donation != 0 %}
                    <tr>
                        <th>Donation amount</th>
                        <td>{{contract.donation_tax|format_number}} ISK ( {{donation}} % )</td>
                    </tr>
                    {% endif %}
                    <tr style="border-top: dotted;">
                        <th>Net price</th>
                        <td>{{contract.net_price|format_number}} ISK</td>
                    </tr>
                </tbody>
            </table>
        </div>        
    </div>
    <div class="card" style="margin-top: 10px;">
        <div class="card-header">
            Item Details    
        </div>
        <div class="card-body">
            <table class="table no-footer w-100">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Quantity</th>
                        <th>Jita Buy / Sell</th>
                        <th>Base Price</th>
                        <th>Tax</th>
                        <th>Our Price</th>
                        <th>Total</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in list_items %}
                    <tr>
                        <td>
                            <img class="item-icon" src="https://image.eveonline.com/Type/{{item.item_id}}_32.png">
                            {{item.item_name}}
                        </td>
                        <td>{{item.amount}}</td>
                        <td>{{item.buy_price|format_number}} / {{item.sell_price|format_number}}</td>
                        <td>
                            {% if program.jita_buy %}
                                {{item.buy_price|format_number}}
                            {% else %}
                                {{item.sell_price|format_number}}
                            {% endif %}
                        </td>
                        <td>{{item.item_tax}} %</td>
                        <td>{{item.final_price|format_number}}</td>
                        <td>{{item.total|format_number}}</td>
                        <td>
                            {% if not item.is_allowed %}
                            <i style="color: red; margin: 0;" class="bi bi-hand-thumbs-down" title="{{item.item_name}} is disallowed in this program"></i>
                            {% endif %}
                            {% if item.final_price == 0 %}
                            <i style="color: red; margin: 0;" class="bi bi-question-lg" title="{{item.item_name}} has no price data"></i>
                            {% endif %}
                            {% if item.tax_difference < 0 %}
                            <i style="color: green; margin: 0;" class="bi bi-percent" title="{{item.item_name}} has an decreased {{item.tax_difference}} % item specific tax applied on it"></i>
                            {% endif %}
                            {% if item.tax_difference > 0 %}
                            <i style="color: gold; margin: 0;" class="bi bi-percent" title="{{item.item_name}} has an additional {{item.tax_difference}} % item specific tax applied on it"></i>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    <div class="card" style="margin-top: 10px;">
        <div class="card-header">Contract Calculator</div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                <div class="from-group">
                    <label for="items">Items</label>
                    <textarea style="resize: none;" class="form-control" name="items" id="items" rows="10" required></textarea>
                    <small class="form-text text-muted">Copy and paste the item data from your inventory.</small>
                </div>
                <div class="from-group">
                    <label for="donation">Donation (%)</label>
                    <input type="number" name="donation" id="donation" min="0" max="100" class="form-control" value="0">
                    <small class="form-text text-muted">You can set a optional donation percentage on your contract</small>
                </div>
                <div class="d-grid gap-2 my-2">
                    <button type="submit" class="btn btn-success">Calculate</button>
                </div>
            </form>
        </div>
        <div class="card-footer">
            <b>Selected Program: </b> {{program.name}}
        </div>
    </div>
</div>
<script src="{% static 'js/calculate.js' %}"></script>
{% endblock %}